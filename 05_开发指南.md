# OSATE2 开发指南

## 1. 开发环境搭建

### 1.1 前提条件

| 要求 | 版本 |
|------|------|
| JDK | 21 |
| Maven | 3.9.0+ |
| Git | 最新版 |
| 内存 | 建议8GB+ |

### 1.2 获取源代码

```bash
# 克隆仓库
git clone https://github.com/osate/osate2.git

# 进入目录
cd osate2
```

### 1.3 Eclipse IDE设置

**推荐IDE：** Eclipse for RCP and RAP Developers

**必需插件：**
- Xtext SDK 2.39.0
- Xtend SDK 2.39.0
- EMF SDK
- GEF SDK

**安装步骤：**

1. 下载Eclipse RCP版本
2. 安装Xtext SDK（从Eclipse Marketplace）
3. 导入OSATE2项目

### 1.4 导入项目

**方法一：Maven导入**
```
File → Import → Maven → Existing Maven Projects
选择osate2根目录
```

**方法二：使用Oomph**
项目提供Oomph setup文件，位于`setup/`目录。

## 2. 项目构建

### 2.1 命令行构建

```bash
# 完整构建
mvn clean verify

# 跳过测试
mvn clean verify -DskipTests

# 快速构建（跳过质量检查）
mvn clean verify -DskipTests -Dspotbugs.skip=true

# 构建特定模块
mvn clean verify -pl core/org.osate.aadl2 -am
```

### 2.2 构建选项

| 选项 | 描述 |
|------|------|
| `-DskipTests` | 跳过测试 |
| `-Dspotbugs.skip=true` | 跳过SpotBugs分析 |
| `-Dmaven.javadoc.skip=true` | 跳过Javadoc生成 |
| `-pl <module>` | 构建指定模块 |
| `-am` | 同时构建依赖模块 |

### 2.3 构建产物

构建完成后，产物位于：
- 更新站点: `releng/org.osate.build.repository/target/repository/`
- 产品: `releng/org.osate.build.product/target/products/`

## 3. 运行与调试

### 3.1 启动运行时工作台

1. 在Eclipse中选择任意OSATE插件项目
2. 右键 → Run As → Eclipse Application
3. 或者 Debug As → Eclipse Application

### 3.2 调试配置

创建新的Eclipse Application启动配置：

```
Run → Run Configurations → Eclipse Application → New
```

**推荐设置：**
- VM Arguments: `-Xmx4g`
- 选择所有工作空间插件

### 3.3 日志查看

运行时日志位置：
- 控制台输出
- `workspace/.metadata/.log`

## 4. 代码组织规范

### 4.1 包命名约定

```
org.osate.<module>           # 核心API
org.osate.<module>.impl      # 实现类
org.osate.<module>.util      # 工具类
org.osate.<module>.ui        # UI相关
org.osate.<module>.tests     # 测试
```

### 4.2 模块结构

```
org.osate.example/
├── src/
│   └── org/osate/example/
│       ├── ExampleApi.java       # 公开API
│       ├── impl/                 # 内部实现
│       └── util/                 # 工具类
├── src-gen/                      # 生成代码（不要手动编辑）
├── xtend-gen/                    # Xtend编译输出
├── model/                        # 模型文件
├── META-INF/
│   └── MANIFEST.MF
├── plugin.xml
├── build.properties
└── pom.xml
```

### 4.3 MANIFEST.MF规范

```manifest
Manifest-Version: 1.0
Bundle-ManifestVersion: 2
Bundle-Name: Example Plugin
Bundle-SymbolicName: org.osate.example;singleton:=true
Bundle-Version: 2.18.0.qualifier
Bundle-Activator: org.osate.example.Activator
Bundle-Vendor: CMU/SEI
Require-Bundle: org.eclipse.core.runtime,
 org.osate.aadl2;bundle-version="[6.0.0,7.0.0)"
Bundle-RequiredExecutionEnvironment: JavaSE-21
Export-Package: org.osate.example
```

## 5. 扩展开发

### 5.1 创建新分析插件

**步骤1：创建插件项目**
```
File → New → Plug-in Project
项目名: org.osate.analysis.myanalysis
```

**步骤2：添加依赖**

在MANIFEST.MF中添加：
```manifest
Require-Bundle: org.osate.aadl2,
 org.osate.aadl2.modelsupport,
 org.osate.ui
```

**步骤3：实现分析类**

```java
package org.osate.analysis.myanalysis;

import org.osate.aadl2.instance.SystemInstance;
import org.osate.ui.handlers.AbstractInstanceOrDeclarativeModelReadOnlyHandler;

public class MyAnalysisHandler extends AbstractInstanceOrDeclarativeModelReadOnlyHandler {

    @Override
    protected void analyzeInstanceModel(SystemInstance si) {
        // 实现分析逻辑
    }
}
```

**步骤4：注册菜单项**

在plugin.xml中：
```xml
<extension point="org.eclipse.ui.commands">
    <command id="org.osate.analysis.myanalysis.run"
             name="My Analysis"/>
</extension>

<extension point="org.eclipse.ui.menus">
    <menuContribution locationURI="menu:org.osate.ui.menu.analyses">
        <command commandId="org.osate.analysis.myanalysis.run"/>
    </menuContribution>
</extension>

<extension point="org.eclipse.ui.handlers">
    <handler class="org.osate.analysis.myanalysis.MyAnalysisHandler"
             commandId="org.osate.analysis.myanalysis.run"/>
</extension>
```

### 5.2 扩展图形编辑器

**添加新的图形元素：**

1. 实现`DiagramElementHandler`接口
2. 注册扩展点`org.osate.ge.businessObjectHandlers`

```java
public class MyHandler implements BusinessObjectHandler {
    @Override
    public boolean isApplicable(Object bo) {
        return bo instanceof MyElement;
    }

    @Override
    public void buildCanvasHierarchy(BusinessObjectContext ctx) {
        // 定义子元素
    }
}
```

### 5.3 创建新语言扩展

**使用Xtext创建新语言：**

1. 创建Xtext项目
2. 定义语法（.xtext文件）
3. 运行Xtext代码生成
4. 实现验证器、作用域提供者等

```xtext
grammar org.osate.mylang.MyLang with org.eclipse.xtext.common.Terminals

generate myLang "http://www.osate.org/mylang/MyLang"

Model:
    elements+=Element*;

Element:
    'element' name=ID '{'
        features+=Feature*
    '}';

Feature:
    'feature' name=ID ':' type=ID;
```

## 6. 测试指南

### 6.1 单元测试

使用JUnit 5编写测试：

```java
package org.osate.analysis.myanalysis.tests;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class MyAnalysisTest {

    @Test
    void testAnalysis() {
        // 测试代码
    }
}
```

### 6.2 Xtext语言测试

```java
@ExtendWith(InjectionExtension.class)
@InjectWith(Aadl2InjectorProvider.class)
class MyLanguageTest {

    @Inject
    ParseHelper<Model> parseHelper;

    @Test
    void testParsing() throws Exception {
        Model model = parseHelper.parse("...");
        assertNotNull(model);
    }
}
```

### 6.3 集成测试

使用Eclipse测试框架进行集成测试：

```java
@RunWith(XtextRunner.class)
@InjectWith(OsateTestInjectorProvider.class)
class IntegrationTest {

    @Inject
    FluentIssueCollection issues;

    @Test
    void testModel() {
        // 加载和测试完整模型
    }
}
```

### 6.4 运行测试

```bash
# 运行所有测试
mvn verify

# 运行特定测试
mvn verify -pl org.osate.analysis.myanalysis.tests

# 生成覆盖率报告
mvn verify -Djacoco.skip=false
```

## 7. 贡献指南

### 7.1 代码风格

- 使用Eclipse默认Java格式化器
- 遵循Java命名约定
- 添加适当的Javadoc注释
- 每个公开API都需要文档

### 7.2 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型：**
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具

### 7.3 Pull Request流程

1. Fork仓库
2. 创建功能分支
3. 提交更改
4. 推送到Fork
5. 创建Pull Request
6. 等待代码审查
7. 合并

### 7.4 问题报告

在GitHub Issues中报告问题，包含：
- OSATE版本
- 操作系统
- 重现步骤
- 期望行为
- 实际行为
- 日志/截图

## 8. 常用API

### 8.1 模型遍历

```java
// 遍历所有组件
for (ComponentInstance ci : EcoreUtil2.getAllContentsOfType(
        systemInstance, ComponentInstance.class)) {
    // 处理组件
}

// 遍历连接
for (ConnectionInstance conn : systemInstance.getAllConnectionInstances()) {
    // 处理连接
}
```

### 8.2 属性访问

```java
// 获取属性值
PropertyExpression pe = PropertyUtils.getSimplePropertyValue(
    component, propertyDefinition);

// 获取整数属性
long value = PropertyUtils.getIntegerValue(component, property, 0);

// 获取时间属性
double time = PropertyUtils.getScaledNumberValue(
    component, timeProperty, TimeUnits.MS);
```

### 8.3 实例化

```java
// 实例化系统
SystemInstance si = InstantiateModel.instantiate(
    systemImplementation);

// 获取根系统实例
SystemInstance root = (SystemInstance) EcoreUtil.getRootContainer(element);
```

### 8.4 结果报告

```java
// 创建分析结果
AnalysisResult result = ResultUtil.createAnalysisResult(
    "My Analysis", systemInstance);

// 添加诊断
Diagnostic diag = ResultUtil.createWarning(
    "Warning message", element);
result.getDiagnostics().add(diag);
```

## 9. 调试技巧

### 9.1 日志记录

```java
import org.osate.aadl2.modelsupport.logging.Log;

// 使用Log工具类
Log.info("Info message");
Log.warning("Warning message");
Log.error("Error message");
```

### 9.2 断点调试

- 在Java代码中设置断点
- 使用Debug模式启动运行时工作台
- 使用条件断点过滤

### 9.3 模型检查

```java
// 检查模型元素
System.out.println("Element: " + element);
System.out.println("Type: " + element.eClass().getName());
System.out.println("Container: " + element.eContainer());
```

## 10. 资源链接

### 官方文档
- OSATE文档: https://osate.org
- 开发者指南: https://osate.org/dev

### 社区
- 邮件列表: https://groups.google.com/g/osate
- GitHub Issues: https://github.com/osate/osate2/issues

### 相关技术
- Xtext文档: https://www.eclipse.org/Xtext/documentation/
- EMF文档: https://www.eclipse.org/modeling/emf/
- Eclipse平台: https://www.eclipse.org/eclipse/
