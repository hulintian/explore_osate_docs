# 构建系统与测试设计

本文档基于源码分析，描述 OSATE2 的构建系统、测试基础设施、产品打包和 CI/CD 流水线设计。

## 1. Maven/Tycho 构建层次

### 1.1 POM 层次结构

```
osate2/pom.xml（根聚合器）
├── releng/org.osate.build.main/pom.xml（父 POM，所有模块继承）
│   ├── 版本属性定义（Xtext、Tycho 等）
│   ├── 插件管理（tycho, xtend, jacoco 等）
│   └── Profile 定义（local, full, codecoverage 等）
│
├── core/                    — 核心模块
├── analyses/                — 分析模块
├── alisa/                   — ALISA 验证框架
├── ba/                      — 行为附件
├── emv2/                    — 错误模型 V2
├── ge/                      — 图形编辑器
├── releng/                  — 发布工程模块
│   ├── org.osate.build.target/    — 目标平台定义
│   ├── org.osate.build.repository/ — P2 更新站点
│   ├── org.osate.build.product/   — RCP 产品构建
│   └── org.osate.build.coverage.report/ — JaCoCo 聚合报告
└── tools/                   — 开发工具
```

### 1.2 关键版本属性

| 属性 | 值 |
|------|-----|
| Java | JavaSE-21 |
| Tycho | 4.0.13 |
| Xtext | 2.39.0 |
| Maven | >= 3.9.0（Enforcer 检查） |
| Eclipse Target | 2025-06 |

### 1.3 构建 Profile

| Profile | 触发条件 | 用途 |
|---------|---------|------|
| `local` | PR 构建 | 编译 + 测试（不打包产品） |
| `full` | master 分支 | 完整构建 + 产品打包 + JavaDoc |
| `codecoverage` | `-Dcodecoverage=true` | JaCoCo 覆盖率收集 |
| `spotbugs` | `-Dspotbugs=true` | SpotBugs 静态分析 |
| `javadoc` | `-Djavadoc=true` | JavaDoc 生成 |

### 1.4 父 POM 插件管理

```xml
<!-- 核心 Tycho 插件 -->
tycho-maven-plugin          — Eclipse/OSGi 构建集成
tycho-compiler-plugin       — Java 编译（JavaSE-21）
tycho-surefire-plugin       — OSGi 测试执行
tycho-p2-repository-plugin  — P2 元数据生成
tycho-p2-publisher-plugin   — P2 发布
tycho-p2-director-plugin    — 产品物化

<!-- 代码生成插件 -->
xtend-maven-plugin          — Xtend → Java 编译
emf-codegen-plugin          — EMF 代码生成（可选）

<!-- 质量插件 -->
jacoco-maven-plugin         — 代码覆盖率
spotbugs-maven-plugin       — 缺陷检测
maven-enforcer-plugin       — Maven 版本强制
maven-clean-plugin          — 清理生成目录
```

## 2. 目标平台

### 2.1 Target 文件

位置：`releng/org.osate.build.target/`

目标平台定义文件（`.target`）指定所有外部依赖的确切版本，确保可重复构建：

```xml
<!-- 关键依赖源 -->
<locations>
  <!-- Eclipse Platform 2025-06 -->
  <location type="InstallableUnit">
    <repository location="https://download.eclipse.org/releases/2025-06"/>
    <unit id="org.eclipse.platform.feature.group"/>
    <unit id="org.eclipse.emf.sdk.feature.group"/>
    <unit id="org.eclipse.gmf.runtime.sdk.feature.group"/>
  </location>

  <!-- Xtext 2.39.0 -->
  <location type="InstallableUnit">
    <repository location="https://download.eclipse.org/modeling/tmf/xtext/updates/releases/2.39.0/"/>
  </location>

  <!-- 其他：ELK、Sirius、EASE、OpenJFX 等 -->
</locations>
```

### 2.2 Maven 本地仓库

```xml
<!-- seisettings.xml -->
<localRepository>.repository</localRepository>
```

使用工作空间本地 `.repository` 目录，避免污染用户全局 Maven 仓库。

## 3. 测试基础设施

### 3.1 测试模块总览

**Core 测试**：
| 模块 | 测试内容 |
|------|---------|
| `core/org.osate.core.tests` | AADL 解析、实例化、链接 |
| `core/org.osate.aadl2.instance.textual.tests` | 实例文本语法 |
| `core/org.osate.slicer.tests` | 模型切片 |
| `core/org.osate.ui.tests` | UI 集成测试 |

**ALISA 测试**：
| 模块 | 测试内容 |
|------|---------|
| `alisa/org.osate.alisa.workbench.tests` | 工作台功能 |
| `alisa/org.osate.alisa.common.tests` | 公共基础设施 |
| `alisa/org.osate.assure.tests` | 保证执行引擎 |
| `alisa/org.osate.verify.tests` | 验证计划 |
| `alisa/org.osate.reqspec.tests` | 需求规范 |
| `alisa/org.osate.categories.tests` | 分类体系 |
| `alisa/org.osate.organization.tests` | 组织模型 |

**Analyses 测试**：
| 模块 | 测试内容 |
|------|---------|
| `analyses/org.osate.analysis.architecture.tests` | 架构分析 |
| `analyses/org.osate.analysis.flows.tests` | 流延迟分析 |
| `analyses/org.osate.analysis.modes.tests` | 模式分析 |
| `analyses/org.osate.analysis.resource.budgets.tests` | 资源预算 |
| `analyses/org.osate.modelstats.tests` | 模型统计 |

**BA/EMV2 测试**：
| 模块 | 测试内容 |
|------|---------|
| `ba/org.osate.ba.tests` | 行为附件解析/验证 |
| EMV2 相关测试模块 | 错误模型分析 |

### 3.2 测试框架

**JUnit 4**（主要）：
- 版本 4.13.0
- `@Test`, `@RunWith` 注解
- XtextRunner 集成

**JUnit 5 Jupiter**（辅助）：
- 版本 5.6.0
- `org.junit.jupiter.api`

**Xtext Testing**：
- `org.eclipse.xtext.testing`（版本 [2.12.0, 3.0.0)）
- 提供 `XtextRunner`, `@InjectWith`, `ValidationTestHelper`

### 3.3 自定义测试支持

`org.osate.testsupport`（v4.1.0）提供 OSATE 专用测试基础设施：

| 类 | 职责 |
|----|------|
| `Aadl2InjectorProvider` | Guice 依赖注入，管理 GlobalRegistries 状态隔离 |
| `Aadl2UiInjectorProvider` | UI 层专用注入提供器 |
| `TestHelper<AadlPackage>` | 解析 AADL 文件为 EMF 模型 |
| `XtextTest` | 带 StandaloneSetup 初始化的基础测试类 |
| `FluentIssueCollection` | 流式断言辅助 |

**注入提供器模式**：

```java
Aadl2InjectorProvider (implements IInjectorProvider, IRegistryConfigurator)
  ├── 创建 Aadl2RuntimeModule 的 Guice Injector
  ├── 通过 state memento 管理 GlobalRegistries 状态
  └── 每个测试前后保存/恢复注册表状态（测试隔离）
```

### 3.4 测试模式

**模式 1：XtextRunner + Injection 测试**

```java
@RunWith(XtextRunner.class)
@InjectWith(Aadl2InjectorProvider.class)
public class Issue1671Test {
  private static final String PATH = "org.osate.core.tests/models/issue1671/";

  @Inject
  private TestHelper<AadlPackage> testHelper;

  @Inject
  private ValidationTestHelper validationHelper;

  @Test
  public void testAaronExample() {
    validationHelper.assertNoIssues(
      testHelper.parseFile(PATH + "aaron_example.aadl"));
  }
}
```

**模式 2：模型驱动测试**
1. 通过 `testHelper.parseFile()` 加载 AADL 模型文件
2. 获取 `AadlPackage` EMF AST 对象
3. 通过 `validationHelper.assertNoIssues()` 验证
4. 测试模型实例化、链接、作用域

**模式 3：Issue 驱动的测试组织**

```
core/org.osate.core.tests/models/
├── issue1671/
│   ├── aaron_example.aadl
│   └── ...
├── issue2089/
│   └── ...
└── （100+ issue 特定测试目录）
```

每个 Issue 有独立的 `.aadl` 测试模型文件，包含正向和反向测试用例。

### 3.5 测试 Bundle 依赖

```
Require-Bundle:
  org.osate.aadl2,                           — AADL2 元模型
  org.osate.xtext.aadl2,                     — Xtext 语言
  org.osate.xtext.aadl2.ui,                  — UI 层
  org.eclipse.xtext.testing,                 — Xtext 测试框架
  org.osate.testsupport;visibility:=reexport — OSATE 测试支持

<!-- pom.xml 额外依赖 -->
  org.eclipse.equinox.event                  — OSGi 事件系统
  org.osate.aadl2.model.editor               — 事务编辑域
```

## 4. 产品构建

### 4.1 产品定义

文件：`releng/org.osate.build.product/osate.product`

| 属性 | 值 |
|------|-----|
| 产品名称 | OSATE2 |
| 产品 UID | `osate2` |
| 产品 ID | `org.osate.branding.osate2` |
| Application | `org.eclipse.ui.ide.workbench` |
| 版本 | 2.17.90.qualifier |
| 使用 Features | true |
| 自动包含依赖 | true |

**JVM 参数**：
```
-Dosgi.requiredJavaVersion=1.17
-Dosgi.framework.extensions=org.eclipse.fx.osgi
-Xms40m -Xmx768m
--add-modules=ALL-SYSTEM
```

### 4.2 Feature 组织

```
产品 Feature 引用
├── org.osate.core.feature          — 核心 AADL 元模型/编辑器
├── org.osate.plugins.feature       — 分析/实用工具插件
├── org.osate.xtext.aadl2.errormodel.feature — EMV2 错误模型
├── org.osate.ge.feature            — 图形编辑器
├── org.osate.ge.errormodel.feature — GE EMV2 集成
├── org.osate.ba.feature            — 行为附件
├── org.osate.ge.ba.feature         — GE BA 集成
├── org.osate.utils.feature         — 实用工具
├── org.osate.alisa.workbench.sdk   — ALISA 验证工作台
├── org.osate.examples.feature      — 示例项目
│
├── org.eclipse.platform            — Eclipse 平台
├── org.eclipse.egit                — Git 集成
├── org.eclipse.sirius.runtime.ide.ui — Sirius 建模
├── org.eclipse.elk.feature         — 布局引擎
├── org.eclipse.ease.feature        — 脚本支持
├── org.eclipse.fx.runtime.min.feature — JavaFX 运行时
├── openjfx.standard.feature        — OpenJFX
└── org.eclipse.justj.openjdk.hotspot.jre.full.stripped — JRE
```

### 4.3 核心 Feature 内容

`org.osate.core.feature`（v12.1.1.qualifier）：

```xml
<feature
  id="org.osate.core.feature"
  label="Open Source AADL Tool Environment"
  provider-name="CMU SEI"
  plugin="org.osate.branding"
  license-feature="org.osate.license"
  application="org.eclipse.ui.ide.workbench">

  <plugin id="org.osate.aadl2"/>
  <plugin id="org.osate.aadl2.edit"/>
  <plugin id="org.osate.aadl2.instantiation" unpack="false"/>
  <plugin id="org.osate.aadl2.modelsupport" unpack="false"/>
  <!-- ... -->
</feature>
```

### 4.4 产品打包

```xml
<!-- 平台归档格式 -->
<formats>
  <win32>zip</win32>
  <linux>tar.gz</linux>
  <macosx>tar.gz</macosx>
</formats>

<!-- 归档命名 -->
<archiveFileName>
  ${product.id}-${unqualifiedVersion}-${buildQualifier}
</archiveFileName>

<!-- 根目录 -->
<rootFolders>
  <rootFolder>${product.id}</rootFolder>
  <macosx>${product.id}.app</macosx>
</rootFolders>
```

使用 Tycho 插件链：
1. `tycho-p2-repository-plugin` — 创建 P2 元数据
2. `tycho-p2-publisher-plugin` — 发布构件
3. `tycho-p2-director-plugin` — 物化平台特定产品

## 5. CI/CD 流水线

### 5.1 Jenkinsfile 结构

文件：`osate2/Jenkinsfile`

```
Agent: any
JDK: OpenJDK21

Stage 1: Update Dependencies
    ↓ versions-maven-plugin:use-reactor
Stage 2: Build Pull Request（PR-\d+ 分支）
    ↓ mvn clean verify -P local
Stage 3: Build Products（master 分支）
    ↓ mvn clean verify -P full
Stage 4: Deploy（master 分支）
    ↓ deploy.sh
```

### 5.2 各阶段详细

**阶段 1：依赖更新**
```groovy
mvn -s releng/osate.releng/seisettings.xml \
    org.codehaus.mojo:versions-maven-plugin:use-reactor \
    -DgenerateBackupPoms=false -Dtycho.mode=maven -Dcodecoverage=true
```

**阶段 2：PR 构建**
- 触发：分支匹配 `PR-\d+`
- 运行于 Xvnc 环境（支持 UI 测试）
- 启用：SonarCloud、JaCoCo、SpotBugs
- Profile：`local`

**阶段 3：产品构建**
- 触发：`origin/master` 分支
- 启用：SonarCloud、JaCoCo、JavaDoc
- Profile：`full`
- 生成三平台产品包

**阶段 4：部署**
- 触发：`origin/master` 分支
- 执行 `deploy.sh` 发布构件

### 5.3 质量门

| 工具 | 用途 | 集成方式 |
|------|------|---------|
| JaCoCo | 代码覆盖率 | `recordCoverage(tools: [[parser: 'JACOCO']])` |
| SpotBugs | 缺陷检测 | `recordIssues(tool: spotBugs(...))` |
| SonarCloud | 综合质量分析 | Maven sonar 插件 + GitHub PR 提供器 |
| JUnit | 测试结果 | `junit '**/target/surefire-reports/*.xml'` |

### 5.4 构建后通知

邮件通知触发条件：SUCCESS、FAILURE、UNSTABLE、FIXED
收件人：Git 提交者（Developers）

## 6. 代码生成基础设施

### 6.1 EMF GenModel 代码生成

项目包含 18+ GenModel 文件，覆盖所有 Ecore 元模型：

| 领域 | GenModel 文件 | 输出 |
|------|-------------|------|
| AADL2 核心 | `core/org.osate.aadl2/model/aadl2.genmodel` | 元模型 Java 类 |
| 分析结果 | `analyses/org.osate.analysis.model/model/analysis.genmodel` | 分析模型类 |
| SOM 图 | `analyses/org.osate.analysis.modes/model/SOMGraph.genmodel` | 模式分析类 |
| ALISA Common | `alisa/org.osate.alisa.common/model/generated/Common.genmodel` | 公共模型 |
| Alisa | `alisa/org.osate.alisa.workbench/model/generated/Alisa.genmodel` | 工作台模型 |
| Assure | `alisa/org.osate.assure/model/Assure.genmodel` | 保证模型 |
| ReqSpec | `alisa/org.osate.reqspec/model/generated/ReqSpec.genmodel` | 需求模型 |
| Verify | `alisa/org.osate.verify/model/generated/Verify.genmodel` | 验证模型 |
| Categories | `alisa/org.osate.categories/model/generated/Categories.genmodel` | 分类模型 |
| Organization | `alisa/org.osate.organization/model/generated/Organization.genmodel` | 组织模型 |

**生成配置模式**：
```xml
<genmodel:GenModel
  modelDirectory="/org.osate.analysis.model/src-gen"
  rootExtendsClass="org.eclipse.emf.ecore.impl.MinimalEObjectImpl$Container"
  importerID="org.eclipse.emf.importer.ecore"
  complianceLevel="8.0">
  <foreignModel>analysis.ecore</foreignModel>
</genmodel:GenModel>
```

输出目录：`src-gen/`

### 6.2 Xtext MWE2 工作流

项目包含 18+ MWE2 工作流文件，驱动 Xtext 代码生成：

**AADL2 主工作流**（`GenerateAadl2.mwe2`）：

```
Workflow {
  StandaloneSetup {
    registerGeneratedEPackage = "org.osate.aadl2.Aadl2Package"
    registerGenModelFile = "aadl2.genmodel"
  }
  ↓
  DirectoryCleaner { directory = "src-gen" }
  ↓
  XtextGenerator {
    StandardProjectConfig { ... }
    XtextGeneratorLanguage {
      name = "org.osate.xtext.aadl2.Aadl2"
      fileExtensions = "aadl"

      // 生成片段：
      GrammarAccessFragment2           — 语法访问
      SerializerFragment2              — 序列化器
      ResourceFactoryFragment2         — 资源工厂
      XtextAntlrGeneratorFragment2     — ANTLR 解析器（classSplitting, ignoreCase）
      ValidatorFragment2               — 验证器
      ImportNamespacesScopingFragment2  — 作用域（ignoreCase）
      QualifiedNamesFragment2          — 限定名
      BuilderIntegrationFragment2      — 构建器
      Formatter2Fragment2              — 格式化器
      LabelProviderFragment2           — 标签提供器
      OutlineTreeProviderFragment2     — 大纲
      QuickfixProviderFragment2        — 快速修复
      ContentAssistFragment2           — 内容辅助
      CodetemplatesGeneratorFragment2  — 代码模板
      CompareFragment2                 — 比较
    }
  }
}
```

**ALISA 工作流**：
- `GenerateCommon.mwe2`, `GenerateAlisa.mwe2`
- `GenerateCategories.mwe2`, `GenerateOrganization.mwe2`
- `GenerateReqSpec.mwe2`, `GenerateVerify.mwe2`

### 6.3 Xtend 编译

项目包含 40+ `.xtend` 源文件，编译为 Java：

**Maven 插件配置**：
```xml
<plugin>
  <groupId>org.eclipse.xtend</groupId>
  <artifactId>xtend-maven-plugin</artifactId>
  <configuration>
    <xtendAsPrimaryDebugSource>true</xtendAsPrimaryDebugSource>
    <outputDirectory>${basedir}/xtend-gen</outputDirectory>
  </configuration>
  <executions>
    <goal>compile</goal>
    <goal>testCompile</goal>
    <goal>xtend-install-debug-info</goal>
  </executions>
</plugin>
```

输出目录：`xtend-gen/`

**清理配置**：
```xml
<!-- maven-clean-plugin -->
<fileset>
  <directory>xtend-gen</directory>
  <excludes><exclude>.gitignore</exclude></excludes>
</fileset>
<fileset>
  <directory>xsemantics-gen</directory>
</fileset>
```

### 6.4 生成目录总结

| 目录 | 来源 | 生成器 |
|------|------|--------|
| `src-gen/` | `.ecore` + `.genmodel` / `.xtext` | EMF CodeGen / Xtext MWE2 |
| `xtend-gen/` | `.xtend` | Xtend Maven Plugin |
| `xsemantics-gen/` | Xsemantics 规则 | Xsemantics 生成器 |

## 7. OSGi Bundle 模式

### 7.1 核心 Xtext 插件

```
Bundle-SymbolicName: org.osate.xtext.aadl2;singleton:=true
Bundle-ActivationPolicy: lazy
Bundle-RequiredExecutionEnvironment: JavaSE-21
Bundle-Activator: org.osate.xtext.aadl2.Activator
Automatic-Module-Name: org.osate.xtext.aadl2

Require-Bundle:
  org.osate.aadl2;bundle-version="[6.1.0,7.0.0)",
  org.eclipse.xtext;bundle-version="[2.20.0,3.0.0)";visibility:=reexport,
  org.osate.aadl2.modelsupport;bundle-version="[8.1.0,9.0.0)";visibility:=reexport,
  org.eclipse.xtext.xbase;resolution:=optional;visibility:=reexport

Export-Package:
  org.osate.xtext.aadl2,
  org.osate.xtext.aadl2.parser.antlr,
  org.osate.xtext.aadl2.scoping,
  org.osate.xtext.aadl2.validation,
  org.osate.xtext.aadl2.formatting2
```

### 7.2 关键 OSGi 模式

| 模式 | 说明 |
|------|------|
| `singleton:=true` | 只加载一个版本（UI 插件必需） |
| `Bundle-ActivationPolicy: lazy` | 按需加载（延迟激活） |
| `bundle-version="[6.1.0,7.0.0)"` | 语义版本范围（兼容性保证） |
| `visibility:=reexport` | 传递依赖导出 |
| `resolution:=optional` | 可选依赖 |
| `qualifier` 版本后缀 | 开发快照标识 |

### 7.3 Extension Point 模式

**编辑器注册**：
```xml
<extension point="org.eclipse.ui.editors">
  <editor
    class="...Aadl2ExecutableExtensionFactory:...XtextEditor"
    extensions="aadl"
    default="true"
    id="org.osate.xtext.aadl2.Aadl2"/>
</extension>
```

**Handler 注册**：
```xml
<extension point="org.eclipse.ui.handlers">
  <handler
    class="...Aadl2ExecutableExtensionFactory:...ValidateActionHandler"
    commandId="org.osate.xtext.aadl2.Aadl2.validate">
    <activeWhen>
      <reference definitionId="org.osate.xtext.aadl2.Aadl2.Editor.opened"/>
    </activeWhen>
  </handler>
</extension>
```

**首选项页面注册**：
```xml
<extension point="org.eclipse.ui.preferencePages">
  <page
    category="org.osate.internal.ui.preferences.OsatePreferencePage"
    class="...Aadl2ExecutableExtensionFactory:...Aadl2TextEditorPage"
    id="org.osate.xtext.aadl2.Aadl2"
    name="AADL Text Editor"/>
</extension>
```

**`ExecutableExtensionFactory` 模式**：Xtext 使用服务定位器模式，通过工厂类注入 Guice 管理的依赖。

### 7.4 build.properties 模式

```properties
source.. = src/,\
           src-gen/,\
           xtend-gen
bin.includes = META-INF/,\
               .
```

- `source..` — 源代码目录（包含生成代码）
- `bin.includes` — Bundle JAR 打包内容

## 8. 关键架构模式

| 模式 | 说明 |
|------|------|
| **多层代码生成** | Ecore → GenModel → Java; Xtext → MWE2 → Parser/Serializer; Xtend → Java |
| **Profile 驱动构建** | `local`（PR 快速验证） vs `full`（完整产品构建），通过 Maven Profile 切换 |
| **Issue 驱动测试** | 每个 Issue 对应独立测试目录和 AADL 模型文件 |
| **注入式测试隔离** | `Aadl2InjectorProvider` 通过 GlobalRegistries memento 确保测试隔离 |
| **Feature → Plugin 聚合** | Feature 分组管理 Plugin，Product 引用 Feature，实现分层打包 |
| **版本范围约束** | OSGi `bundle-version` 使用语义版本范围确保兼容性 |
| **工厂模式服务定位** | `ExecutableExtensionFactory` 桥接 Eclipse Extension Point 与 Guice DI |
| **目标平台锁定** | `.target` 文件锁定所有外部依赖版本，确保可重复构建 |
