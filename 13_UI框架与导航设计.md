# UI 框架与导航设计

本文档基于源码分析，描述 OSATE2 的 UI 框架、导航器、编辑器集成和对话框设计。

## 1. AADL 导航器

位置：`core/org.osate.ui/`

### 1.1 导航器视图注册

- ID: `org.osate.ui.navigator.AadlNavigator`
- 基于 Eclipse ProjectExplorer
- 自定义图标: `icons/aadlNav.gif`

### 1.2 内容提供器

**AadlContributionContentProvider**（extends WorkbenchContentProvider）：
- 管理插件贡献的 AADL 包和属性集
- 创建虚拟节点：`VirtualPluginResources`, `ContributedDirectory`
- 通过 `ContributedAadlStorage` 处理贡献资源
- 集成 `PredeclaredProperties` 处理禁用/覆盖的资源

**AadlElementContentProvider**（implements ITreeContentProvider）：
- 展开 AADL 文件内容（包、分类器、组件）
- 支持工作空间文件和贡献存储
- 使用 `EObjectURIWrapper` 工厂延迟加载模型元素
- 限制每个节点显示最多 150 个子项
- 过滤 `SystemOperationMode` 和 `PropertyAssociation`

**AadlProjectDependenciesContentProvider**：
- 在导航器中显示项目依赖
- 创建虚拟依赖节点

### 1.3 标签提供器

**AadlElementLabelProvider**：
- 提供 AADL 模型元素的文本和图标
- 委托给 `EObjectURIWrapper` 实际渲染
- 实现 `IDescriptionProvider` 提供工具提示

**AadlContributionLabelProvider**：
- 处理贡献资源的标签
- 显示覆盖状态（如 "filename (overridden)"）
- 区分插件贡献和工作空间文件

### 1.4 排序器

- `AadlContributionSorter` — 贡献资源排序
- `AadlElementSorter` — AADL 元素排序
- `AadlProjectDependenciesSorter` — 依赖排序

## 2. 实例模型查看器

### 2.1 实例编辑器注册

- 编辑器 ID: `org.osate.aadl2.instance.presentation.InstanceEditorID`
- 扩展名: `.aaxl2`, `.aail2`
- 类: `Aadl2ModelEditor`
- 贡献器: `Aadl2ActionBarContributor`

### 2.2 大纲视图

`Aadl2OutlineTreeProvider`（extends BackgroundOutlineTreeProvider）：
- 自定义树提供器，支持实例和声明式模型
- 支持 `SystemInstance` 导航
- 通过 `ParseResultHolder` 委托给 Annex 特定大纲提供器

### 2.3 内容显示

集成 EMF Edit 的提供器基础设施：
- `AdapterFactoryContentProvider` + `AdapterFactoryLabelProvider`
- 组合适配器工厂：
  - `Aadl2ItemProviderAdapterFactory`
  - `InstanceItemProviderAdapterFactory`
  - `ResourceItemProviderAdapterFactory`
  - `ReflectiveItemProviderAdapterFactory`

## 3. 属性视图集成

位置：`core/org.osate.xtext.aadl2.ui/src/.../propertyview/`

### 3.1 关键接口

**IAadlPropertySource**：
- 向属性视图提供 AADL 元素
- 方法：`getNamedElement()`, `getDocument()`
- 返回 `NamedElement` 和 `IXtextDocument`

### 3.2 支撑类

| 类 | 职责 |
|----|------|
| `OsateStyledTextCellEditor` | 属性值的自定义 SWT 单元格编辑器 |
| `OsateSourceViewerEx` | 属性中的 AADL 代码编辑扩展源查看器 |
| `OsateStyledTextXtextAdapter` | Xtext 编辑器与属性视图的桥接 |
| `PropertyStatus` | 属性变更的状态跟踪 |

### 3.3 自定义属性视图

- ID: `org.osate.xtext.aadl2.ui.propertyview.AadlPropertyView`
- 在 AADL 透视图底部面板注册

## 4. 向导框架

### 4.1 新建项目向导

- ID: `org.osate.ui.wizards.AadlProjectWizardID`
- 类: `AadlProjectWizard`
- 功能：
  - 创建带 AADL Nature 的项目
  - 验证项目名称（不允许空格）
  - 应用 Xtext Nature (`XtextProjectHelper`)
  - 支持项目引用

### 4.2 新建文件向导

| 向导 | ID | Handler |
|------|----|---------|
| 新 AADL 包 | `org.osate.ui.NewAadlPackageWizard` | `NewPackageWizardHandler` |
| 新属性集 | `org.osate.ui.NewPropertySetWizard` | `NewPropertySetWizardHandler` |
| AADL 示例 | — | `OsateExampleWizard` |

## 5. 首选项页面

### 5.1 首选项层次

```
OSATE (根)
├── Analysis — 分析选项（空白页，子页面由分析插件提供）
├── Annexes — Annex 配置（AnnexPreferencePage）
├── Instantiation — 实例化首选项
│   └── SOM 生成限制、实例化设置
├── Contributed Resources — 插件贡献管理
├── Property Sets — 忽略的属性集配置
└── AADL Text Editor — Xtext 编辑器首选项
    ├── Syntax Coloring — 语法着色
    └── Templates — 代码模板
```

### 5.2 实例化首选项

`InstantiationPreferencePage`（extends FieldEditorPreferencePage）：
- 最大 SOM 数量设置
- 支持项目特定配置（链接到项目属性页）
- 存储在 `OsateCorePlugin` 的 PreferenceStore

## 6. 错误/Marker 框架

位置：`core/org.osate.aadl2.modelsupport/src/.../errorreporting/`

### 6.1 错误报告器层次

```
AbstractAnalysisErrorReporter — 基类
├── MarkerAnalysisErrorReporter — 创建 Eclipse IMarker（主渠道）
├── LogAnalysisErrorReporter — 记录到 Eclipse 错误日志
├── StringBufferAnalysisErrorReporter — 缓冲消息
├── QueuingAnalysisErrorReporter — 队列消息（实例化期间使用）
├── ChainedAnalysisErrorReporter — 链式多个报告器
└── NullAnalysisErrorReporter — 空操作实现
```

### 6.2 MarkerAnalysisErrorReporter

创建 Eclipse IMarker 实例用于分析错误：

```java
createMarker(severity, message, aadlURI)  // 创建带严重级别的 Marker
errorImpl(element, message)               // IMarker.SEVERITY_ERROR
warningImpl(element, message)             // IMarker.SEVERITY_WARNING
infoImpl(element, message)                // IMarker.SEVERITY_INFO
deleteMessagesImpl()                      // 清除所有给定类型的 Marker
```

使用工厂模式：`MarkerAnalysisErrorReporter.Factory`

### 6.3 AnalysisErrorReporterManager

管理跨多个资源的错误报告器：
- 通过 HashMap 维护 `Resource → AnalysisErrorReporter` 映射
- `getReporterFor(Resource)` — 获取资源的报告器
- `pushPrefix()` / `popPrefix()` — 管理层次化消息前缀

### 6.4 Marker 类型注册

```xml
<!-- 基础 Marker 类型 -->
<extension point="org.eclipse.core.resources.markers">
  <super type="org.osate.aadl2.modelsupport.AadlObjectMarker"/>
  <!-- 各分析插件定义特定 Marker 类型 -->
</extension>
```

## 7. 命令与 Handler 框架

### 7.1 核心命令

| 命令 | 快捷键 | Handler |
|------|--------|---------|
| 实例化 | Ctrl+I | `InstantiationHandler` |
| 重新实例化 | Ctrl+R | `ReinstantiationHandler` |
| 分类器信息 | Ctrl+C | `OpenInClassifierInfoViewHandler` |
| 添加/移除 AADL Nature | — | `ConversionHandler` |
| 可视化项目依赖 | — | `VisualizeProjectDependenciesHandler` |
| 可视化模型单元依赖 | — | `VisualizeModelUnitDependenciesHandler` |

### 7.2 菜单结构

```
OSATE 菜单（AADL 透视图中）
├── 工作流子菜单
├── 导入/导出子菜单
├── 报告生成子菜单
├── Ocarina 子菜单
├── 实例化/重新实例化命令
│
Analyses 菜单
├── Budget 子菜单
├── Semantic Checks 子菜单
├── Timing 子菜单
├── Safety 子菜单
├── Model Maintenance 子菜单
└── Miscellaneous 子菜单
```

### 7.3 属性测试器

| 测试器 | 用途 |
|--------|------|
| `ContributedAadlStoragePropertyTester` | 测试贡献的 AADL 存储属性 |
| `EObjectNodeAadlSuperTypePropertyTester` | 测试大纲节点元素类型 |
| `AadlFileTypePropertyTester` | 测试 AADL 包/属性集文件 |

## 8. 对话框框架

### 8.1 SOM 选择对话框

`SOMChooserDialog`（extends TitleAreaDialog）：
- 允许用户为模态组件选择模式
- TreeViewer 显示组件实例层次
- 每个模态组件有模式实例组合框
- 视觉指示器：`mode_set.gif`, `mode_not_set.gif`, `nonexistent.gif`
- 通过 `getSOM()` 和 `getSOMName()` 获取结果

### 8.2 实例化对话框

| 对话框 | 用途 |
|--------|------|
| `InstantiationResultsDialog` | 显示实例化操作结果 |
| `InstantiateSelectionDialog` | 选择要实例化的组件 |
| `ProjectSelectionDialog` | 过滤 AADL 项目（用于首选项页面） |

## 9. 视图系统

### 9.1 注册的视图

| 视图 | ID | 功能 |
|------|----|------|
| AADL 导航器 | `org.osate.ui.navigator.AadlNavigator` | 项目/文件浏览 |
| 项目依赖可视化 | `org.osate.ui.projectdependencyvisualization` | 项目依赖图 |
| 模型单元依赖可视化 | `org.osate.ui.modelunitdependencyvisualization` | 包/属性集依赖图 |
| 日志查看器 | `org.osate.ui.logger_view` | OSATE 操作日志 |
| 分类器信息视图 | `org.osate.ui.classifier_info_view` | 分类器详细信息 |

### 9.2 AADL 透视图

`AadlPerspectiveFactory` 定义的布局：

```
┌──────────────┬───────────────────────────┬────────────┐
│              │                           │            │
│  AADL        │                           │  Outline   │
│  Navigator   │      Editor Area          │  View      │
│  (25%)       │                           │  (25%)     │
│              │                           │            │
├──────────────┴───────────────────────────┴────────────┤
│ Problems | Properties | AADL Property View |           │
│ Classifier Info | Dependency Visualizations             │
│ (底部面板)                                              │
└────────────────────────────────────────────────────────┘
```

## 10. Xtext 编辑器集成

位置：`core/org.osate.xtext.aadl2.ui/`

### 10.1 编辑器注册

- ID: `org.osate.xtext.aadl2.Aadl2`
- 扩展名: `.aadl`
- 使用 `Aadl2ExecutableExtensionFactory` 服务定位模式

### 10.2 编辑器功能

| 功能 | 实现类 |
|------|--------|
| 内容辅助 | `AnnexAwareContentAssistProcessor` |
| 自动编辑 | `Aadl2AutoEditStrategyProvider` + 缩进策略 |
| 语义高亮 | `Aadl2SemanticHighlightingCalculator` |
| 大纲 | `Aadl2OutlineTreeProvider` |
| 标签 | `Aadl2LabelProvider` + `AnnexAwareLabelProvider` |
| 悬停 | `Aadl2EObjectHoverProvider` |
| 出现计算 | `Aadl2OccurrenceComputer` |
| 快速修复 | `Aadl2QuickfixProvider` |

## 11. 关键架构模式

| 模式 | 说明 |
|------|------|
| **双导航路径** | 工作空间文件通过标准导航器 + 插件贡献通过虚拟节点 |
| **错误报告链** | Manager 协调多个 Reporter，支持链式和队列模式 |
| **内容/标签分离** | 分离的 ContentProvider 和 LabelProvider，支持不同数据源 |
| **命令/Handler 架构** | plugin.xml 定义命令，Handler 实现逻辑，PropertyTester 控制可见性 |
| **对话框驱动操作** | SOM 选择、项目/文件选择、结果显示均通过模态对话框 |
| **延迟加载** | `EObjectURIWrapper` 避免预加载完整模型 |
