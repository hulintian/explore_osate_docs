# 行为附件（Behavior Annex）设计

本文档基于源码分析，描述 OSATE2 的行为附件（BA）子系统设计。

## 1. 架构概览

BA 是 AADL 的标准 Annex 子语言，为组件定义行为状态机（状态、转换、动作序列）。与 EMV2 使用 Xtext 不同，BA 使用 **ANTLR 4.4** 解析器。

源码位置：`ba/org.osate.ba/`（328 个 Java 文件）

## 2. 语法结构

### 2.1 ANTLR 语法文件

位置：`ba/org.osate.ba/src/.../parser/AadlBa.g`（1,831 行）

语法按 AADL-BA 规范的附录章节组织为四大部分：

| 章节 | 行范围 | 内容 |
|------|--------|------|
| D.3 Behavior Specification | 240-649 | 行为规格、变量、状态、转换 |
| D.4 Thread Dispatch Behavior | 652-760 | 调度条件、触发器、模式切换 |
| D.6 Behavior Action Language | 762-1306 | 赋值、通信、定时、控制流 |
| D.7 Behavior Expression Language | 1309-1630 | 表达式优先级层次 |

### 2.2 核心语法规则

```
behavior_annex:
    [variables] [states] [transitions]

behavior_variable_list:
    'variables' (variable_declaration)+

behavior_state_list:
    'states' (state_declaration)+
    // 每个状态可标记: initial, complete, final

behavior_transition:
    [id ':'] source_state_list '-[' condition ']->' dest_state
    [behavior_action_block] ';'

behavior_action_block:
    '{' behavior_actions '}' [timeout behavior_time]

behavior_actions:
    behavior_action (';' behavior_action)*    // 顺序执行
  | behavior_action ('&' behavior_action)*    // 并发执行
```

### 2.3 与 AADL2 的关系

- 复用 AADL2 基础元素：`qualifiable_named_element`, `unique_component_classifier_reference`
- 复用 AADL2 字面量：`INTEGER_LIT`, `REAL_LIT`, `STRING_LITERAL`
- 语法规则通过 `returns [ClassName]` 映射到 Ecore 类

## 3. 元模型设计

### 3.1 Ecore 模型

| 文件 | 说明 |
|------|------|
| `ba/org.osate.ba/model/aadlba.ecore`（818 行） | 核心行为附件元模型 |
| `ba/org.osate.ba/model/declarative.ecore`（119 行） | 未解析的声明式模型 |

NS URI: `https://github.com/osate/osate2-ba.git`

### 3.2 核心类层次

```
BehaviorAnnex (extends AnnexSubclause, BehaviorElement) — 根容器
├── variables: BehaviorVariable[]
├── states: BehaviorState[]
├── transitions: BehaviorTransition[]
└── initialState: BehaviorState

BehaviorState (extends BehaviorNamedElement)
├── initial: boolean
├── complete: boolean
├── final: boolean
├── bindedMode → Mode
├── incomingTransitions ⟷ outgoingTransitions (双向)

BehaviorTransition (extends BehaviorNamedElement)
├── priority: int (-1 默认, 0-255 有效)
├── sourceState → BehaviorState
├── destinationState → BehaviorState
├── condition → BehaviorCondition
└── actionBlock → BehaviorActionBlock

BehaviorVariable (extends BehaviorNamedElement, ArrayableElement, Data)
├── dataClassifier → DataClassifier
├── arrayDimensions: ArrayDimension[]
└── ownedValueConstant → ValueConstant
```

### 3.3 动作类层次

```
BehaviorAction (interface)
├── BasicAction (interface)
│   ├── AssignmentAction — target := valueExpression | ANY
│   ├── CommunicationAction (interface)
│   │   ├── SubprogramCallAction — 子程序调用
│   │   ├── PortSendAction — 端口发送 (port !)
│   │   ├── PortDequeueAction — 端口出队 (port ?)
│   │   ├── PortFreezeAction — 端口冻结
│   │   ├── LockAction — 数据锁定
│   │   └── UnlockAction — 数据解锁
│   └── TimedAction — computation (时间范围) [in binding (处理器)]
│
├── CondStatement (interface)
│   ├── IfStatement — if/elsif/else/end if
│   └── LoopStatement (interface)
│       ├── ForOrForAllStatement — for/forall 循环
│       └── WhileOrDoUntilStatement — while/do-until 循环
│
└── BehaviorActionBlock — { actions } [timeout]
```

### 3.4 条件类层次

```
BehaviorCondition (interface)
├── DispatchCondition — 调度条件 (dispatchTriggerCondition + frozenPorts)
├── ExecuteCondition (interface)
│   ├── ValueExpression — 逻辑表达式
│   ├── ExecutionTimeoutCatch — 执行超时捕获
│   └── Otherwise — 默认条件
└── ModeSwitchTriggerCondition — 模式切换触发条件
```

### 3.5 表达式/值类层次

```
Value (interface)
├── ValueConstant
│   ├── BehaviorIntegerLiteral, BehaviorRealLiteral
│   ├── BehaviorBooleanLiteral, BehaviorStringLiteral
│   ├── PropertySetPropertyReference
│   └── BehaviorPropertyConstant
│
├── ValueVariable
│   ├── Reference — 变量/特征引用
│   ├── PortCountValue — port'count
│   └── PortFreshValue — port'fresh
│
└── ValueExpression
    ├── relations: Relation[]
    └── logicalOperators: LogicalOperator[] (AND, OR, XOR)

表达式分解链:
ValueExpression → Relation → SimpleExpression → Term → Factor → Value
```

### 3.6 声明式模型

`declarative.ecore` 表示解析后但**未语义解析**的 BA 元素：

| 类 | 用途 |
|----|------|
| `DeclarativeBehaviorTransition` | 基于文本的源/目标状态引用 |
| `Identifier` | 未解析的标识符 |
| `Reference` + `ArrayableIdentifier[]` | 未解析的引用路径 |
| `QualifiedNamedElement` | 限定名元素 |
| `CommAction` | 未解析的通信动作 |
| `DeclarativeTime` | 未解析的时间值 |

## 4. 动作语言详细设计

### 4.1 赋值动作

```
target := value_expression | ANY
```
- 目标可以是变量、端口、数据访问、参数或子组件字段
- `ANY` 支持非确定性赋值
- 类型检查由 `AadlBaTypeChecker` 执行

### 4.2 通信动作

| 动作 | 语法 | 说明 |
|------|------|------|
| 子程序调用 | `qualified_name ! [(params)]` | 调用子程序 |
| 端口发送 | `port ! [(value)]` | 向端口发送数据 |
| 端口接收 | `port ? [(target)]` 或 `port >> [()]` | 从端口接收数据 |
| 端口属性 | `port'count`, `port'fresh` | 读取端口计数/新鲜度 |
| 数据锁定 | `lock [data_name]` | 获取共享数据锁 |
| 数据解锁 | `unlock [data_name]` | 释放共享数据锁 |

### 4.3 定时动作

```
computation (lower_time [.. upper_time]) [in binding (processor_list)]
```
- `BehaviorTime` = 整数值 + 单位标识符（如 "5 ms"）
- 支持执行时间范围和处理器绑定

### 4.4 控制流

| 语句 | 语法 | 说明 |
|------|------|------|
| If | `if (cond) { } elsif (cond) { } else { } end if` | 条件分支（支持多级 elsif） |
| For | `for (e : T in values) { }` | 顺序迭代 |
| Forall | `forall (e : T in values) { }` | 并发迭代 |
| While | `while (cond) { }` | 前测循环 |
| Do-Until | `do { } until (cond)` | 后测循环（至少执行一次） |

### 4.5 动作组合

```
action_1 ; action_2 ; action_3    — 顺序执行（BehaviorActionSequence）
action_1 & action_2 & action_3    — 并发执行（BehaviorActionSet）
```

## 5. 集成机制

### 5.1 Annex 扩展点注册

在 `ba/org.osate.ba/plugin.xml` 中注册：

| 扩展点 | 类 | 职责 |
|--------|------|------|
| `annexsupport.parser` | `AadlBaParserAction` | 解析 BA 文本为 BehaviorAnnex EMF 模型 |
| `annexsupport.resolver` | `AadlBaResolver` | 语义分析和交叉引用解析 |
| `annexsupport.unparser` | `AadlBaUnParserAction` | 序列化 BA 模型为文本 |
| `annexsupport.highlighter` | `AadlBaSemanticHighlighter` | 编辑器语法高亮 |
| `annexsupport.textpositionresolver` | `AadlBaTextPositionResolver` | 文本位置映射 |
| `ecore.generated_package` | `AadlBaPackage` | 注册 aadlba Ecore 元模型 |

### 5.2 解析流水线

```
AADL 文本中 'annex behavior_specification {** ... **}'
    ↓ AnnexParserAgent 捕获 ANNEXTEXT
    ↓ AnnexParserRegistry 查找 "behavior_specification"
AadlBaParserAction (implements AnnexParser)
    ↓
AadlBaLexer (ANTLR4 词法分析)
    ↓
AadlBaParser.behavior_annex() (ANTLR4 语法分析)
    ↓
AadlBaParserVisitor<Boolean> (遍历解析树，创建 EMF 对象)
    ↓
BehaviorAnnex EMF 模型（声明式，未解析引用）
```

### 5.3 解析流水线

```
AadlBaResolver (implements AnnexResolver)
    ↓
1. AadlBaNameResolver — 名称解析
   ├── 阶段1: 状态名称解析
   └── 阶段2: 特征/变量引用解析（导航 AADL2 模型）
    ↓
2. AadlBaTypeChecker + AdaLikeDataTypeChecker — 类型检查
    ↓
3. AadlBaRulesCheckersDriver — 协调三个规则检查器
   ├── AadlBaLegalityRulesChecker
   ├── AadlBaSemanticRulesChecker
   └── AadlBaConsistencyRulesChecker
    ↓
4. DeclarativeUtils.reinstanciateBehaviorTransition() — 转换重实例化
```

## 6. 验证架构

### 6.1 多阶段验证流水线

```
1. 语法验证（Parser 级）
    ↓
2. 名称解析（AadlBaNameResolver）
    ↓
3. 类型检查（AadlBaTypeChecker + AdaLikeDataTypeChecker）
    ↓
4. 语义规则（AadlBaSemanticRulesChecker）
    ↓
5. 合法性规则（AadlBaLegalityRulesChecker）
    ↓
6. 一致性规则（AadlBaConsistencyRulesChecker）
```

### 6.2 验证器详细

| 验证器 | 行数 | 检查内容 |
|--------|------|---------|
| **AadlBaLegalityRulesChecker** | 900+ | D.3-D.7 合法性规则：初始状态存在且唯一、转换正确指定源/目标、调度条件仅在可执行线程上 |
| **AadlBaSemanticRulesChecker** | 200+ | D.3-D.7 语义规则：行为规格约束、调度超时/停止条件、动作和表达式语义约束 |
| **AadlBaConsistencyRulesChecker** | 300+ | 一致性约束：转换可达性分析、状态连通性、动作块超时放置、嵌套语句一致性 |
| **AadlBaTypeChecker** | 800+ | 表达式类型推断和兼容性：数值精度、枚举兼容、记录/数组访问、属性类型 |
| **AadlBaNameResolver** | 800+ | 两阶段解析：状态名称 → 特征/变量引用（导航子组件、原型绑定、数据分类器） |
| **AdaLikeDataTypeChecker** | — | Ada 95 风格类型强制转换规则 |

### 6.3 规则检查驱动器

`AadlBaRulesCheckersDriver` 使用 `AadlBaSwitch<Boolean>` 分发模式协调三个规则检查器，管理当前行为转换上下文。

所有验证器使用 `AnalysisErrorReporterManager` 报告错误，支持位置信息（行、列、源文件）和警告/错误严重级别。

## 7. 图形编辑器集成

位置：`ge/org.osate.ge.ba/`（46 个 Java 文件）

### 7.1 Business Object Handler

| Handler | 视觉表示 | 能力 |
|---------|---------|------|
| `BehaviorSpecificationHandler` | 顶层图表 | 内容/可见性控制 |
| `BehaviorStateHandler` | 椭圆形状（居中标签） | 自定义重命名/删除（级联清理） |
| `BehaviorTransitionHandler` | 有向箭头/连接器 | 优先级可视化、条件/动作显示 |
| `BehaviorVariableHandler` | 属性显示 | 名称/类型/初始化显示 |
| `BehaviorConditionHandler` | 文本显示 | 条件类型表示 |

### 7.2 支撑类

| 类 | 职责 |
|----|------|
| `BehaviorAnnexBusinessObjectProvider` | 内容过滤的对象提供器 |
| `BehaviorAnnexReferenceResolver` | 模型导航的引用解析 |
| `BehaviorAnnexReferenceUtil` | 引用编码/解码 |
| `BehaviorAnnexNamingUtil` | 命名约定和冲突解析 |
| `BehaviorAnnexPaletteContributor` | 拖放元素创建 |
| `CreateBehaviorAnnexDiagramHandler` | 创建 BA 图表 |
| `OpenBehaviorAnnexDiagramHandler` | 打开 BA 图表 |

### 7.3 内容过滤器

- `BehaviorSpecificationFilter`
- `BehaviorStateFilter`
- `BehaviorTransitionFilter`
- `BehaviorVariableFilter`
- `BehaviorConditionFilter`
